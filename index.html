<!DOCTYPE html>
if(i !== -1) return i;
}
return -1;
}
const tsIdx = findCol(['időbélyeg','idobelyeg','timestamp','time','dátum','datum']);
let quoteIdx = findCol(['idézet','idezet','quote','szöveg','szoveg','text']);
if(quoteIdx === -1){
const candidates = cols.map((_,i)=>i).filter(i => i !== tsIdx);
quoteIdx = candidates.length ? candidates[0] : 0;
}


const isDateish = (s)=>{ const t = String(s||'').trim(); return /^[0-9\s:\.\/-]{8,25}$/.test(t); };


const out = [];
for(const r of rows){
const c = r.c || [];
const textRaw = c[quoteIdx]?.v ?? '';
const text = String(textRaw).trim();
if(!text) continue;
if(['idézet','quote','text','szöveg','szoveg'].includes(text.toLowerCase())) continue;
if(isDateish(text)) continue;
out.push({text, author: ''});
}
if(!out.length) throw new Error('Nem találtam idézeteket az Approved fülön.');


state.quotes = out;
setStatus(`Betöltve ${out.length} idézet.`, true);
return out;
}catch(err){
console.error(err);
setStatus(err.message || 'Betöltési hiba – minta idézetekkel.', false);
state.quotes = [ {text:'„Az út maga a cél.”'}, {text:'„Ahol akarat van, ott út is van.”'} ];
return state.quotes;
}
}


function setStatus(msg, ok){ els.statusText.textContent = msg; els.statusDot.classList.toggle('ok', !!ok); }


function pickNextIndex(){
if(!state.quotes.length) return 0;
if(!state.shuffling){ state.idx = (state.idx + 1) % state.quotes.length; return state.idx; }
let next, tries=0;
do{ next = Math.floor(Math.random()*state.quotes.length); tries++; if(tries>50) break; } while(state.recent.includes(next));
state.recent.push(next); if(state.recent.length>MAX_RECENT) state.recent.shift();
state.idx = next; return next;
}


function show(idx){ els.quote.textContent = state.quotes[idx]?.text || ''; }


function startShow(){
if(!state.started){
state.started = true;
if(AUDIO_URL && !AUDIO_URL.includes('PASTE_')){ els.bgm.play().catch(()=>{}); }
}
clearInterval(state.timer);
show(pickNextIndex());
state.timer = setInterval(()=>show(pickNextIndex()), SLIDE_SECONDS*1000);
setStatus('Vetítés folyamatban…', true);
}


function pauseShow(){ clearInterval(state.timer); setStatus('Szünetelve.', false); }


els.btnStart.addEventListener('click', async ()=>{ if(!state.quotes.length) await fetchQuotes(); startShow(); });
els.btnNext .addEventListener('click', ()=>{ if(!state.quotes.length) return; pauseShow(); show(pickNextIndex()); });
els.btnPrev .addEventListener('click', ()=>{ if(!state.quotes.length) return; pauseShow(); state.idx=(state.idx-1+state.quotes.length)%state.quotes.length; show(state.idx); });
els.btnPause.addEventListener('click', ()=>{ pauseShow(); els.bgm.pause(); });
els.btnShuffle.addEventListener('click', ()=>{ state.shuffling=!state.shuffling; setStatus(state.shuffling?'Shuffle: BE':'Shuffle: KI'); });
// Automatikus zeneindítás, amikor az oldal betöltődik
window.addEventListener('load', ()=>{
if(AUDIO_URL && !AUDIO_URL.includes('PASTE_')){
els.bgm.play().catch(err=>{
console.warn('Autoplay nem indult el automatikusan:', err);
});
